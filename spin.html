<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spin to Win!</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/winwheel@1.0.1/dist/Winwheel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.3/TweenMax.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.3/plugins/CSSPlugin.min.js"></script>
  <link rel="stylesheet" href="/referral-spin-wheel.io/css/styles.css">
  <style>
    existing style#wheel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 40px 0 20px 0;
            position: relative;
        }
        #wheel {
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 4px 24px rgba(0,0,0,0.15);
            border: 8px solid #4CAF50;
            display: block;
        }
        .pointer {
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-bottom: 40px solid #e74c3c;
            position: absolute;
            top: -38px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }
        #spin-button {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 8px;
            background: #4CAF50;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        #spin-button:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.4);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #fff;
            padding: 40px 30px;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }
  </style>
</head>
<body>
  <div class="container">
    <h1>Spin to Win Ladoos!</h1>
    <div id="wheel-container">
      <div class="pointer"></div>
      <canvas id="wheel" width="400" height="400"></canvas>
    </div>
    <button id="spin-button" disabled>Spin!</button>
    <div id="result-modal" class="modal">
      <div class="modal-content">
        <h2 id="result-title">Congratulations!</h2>
        <p id="result-text"></p>
        <button id="close-modal">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase config and initialization
    const SUPABASE_URL = 'https://nnqxwcmncytolztvvpvi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ucXh3Y21uY3l0b2x6dHZ2cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY4MDg0MjMsImV4cCI6MjA2MjM4NDQyM30.2Ad2Wv3YC9DwxOG82JBF21BGvkS6gbIFOpPXLCWkdso';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Prize configuration with weights
    const PRIZES = [
      { text: '1 Ladoo',   weight: 40 },
      { text: '2 Ladoos',  weight: 20 },
      { text: 'Try Again', weight: 30 },
      { text: '3 Ladoos',  weight: 10 }
    ];

    let wheel;
    let spinButton;
    let resultModal;
    let resultText;
    let resultTitle;
    let closeModalButton;
    let currentToken;
    let alreadyUsed = false;

    document.addEventListener('DOMContentLoaded', async () => {
      spinButton = document.getElementById('spin-button');
      resultModal = document.getElementById('result-modal');
      resultText = document.getElementById('result-text');
      resultTitle = document.getElementById('result-title');
      closeModalButton = document.getElementById('close-modal');

      // Initialize GSAP

      // Add event listeners
      if (closeModalButton) {
        closeModalButton.addEventListener('click', () => {
          resultModal.style.display = 'none';
          // Reset the spin button state
          spinButton.disabled = false;
          spinButton.textContent = 'Spin!';
        });
      }

      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      currentToken = urlParams.get('token');
      if (!currentToken) return showError('No token provided');

      // Validate token and check usage status
      const { data: spinLink, error } = await supabase
        .from('spin_links')
        .select('used')
        .eq('token', currentToken)
        .single();
      
      if (error || !spinLink) return showError('Invalid token');
      
      if (spinLink.used) {
        spinButton.disabled = true;
        spinButton.textContent = 'Already Used';
        resultModal.style.display = 'block';
        resultTitle.textContent = 'Already Used';
        resultText.textContent = 'This spin link has already been used.';
        return;
      }

      // Initialize wheel now that token is valid and unused
      initializeWheel();
    });

    function initializeWheel() {
      const segments = PRIZES.map(p => ({ fillStyle: getRandomColor(), text: p.text }));
      wheel = new Winwheel({
        canvasId: 'wheel',
        numSegments: segments.length,
        segments,
        animation: {
          type: 'spinToStop',
          duration: 5,
          spins: 8,
          callbackFinished: function() {
            handleSpinComplete(wheel.getIndicatedSegment());
          }
        }
      });
      spinButton.disabled = false;
      spinButton.onclick = () => {
        if (alreadyUsed) return;
        console.log('Spin started');
        spinButton.disabled = true;
        const winnerIndex = pickWeightedIndex(PRIZES);
        console.log('Winner index selected:', winnerIndex);
        wheel.animation.stopAngle = wheel.getRandomForSegment(winnerIndex + 1);
        wheel.startAnimation();
      };
    }

    const pickWeightedIndex = (prizes) => {
      let total = prizes.reduce((s, p) => s + p.weight, 0);
      let rand = Math.random() * total;
      for (let i = 0; i < prizes.length; i++) {
        if (rand < prizes[i].weight) return i;
        rand -= prizes[i].weight;
      }
      return 0;
    }

    async function handleSpinComplete(indicatedSegment) {
      console.log('Spin completed');
      const prize = indicatedSegment.text;
      const countWon = parseInt(prize) || 0;
      console.log('Prize won:', prize, 'Count:', countWon);
      try {
        // First, verify the token exists and is not used
        console.log('Verifying token:', currentToken);
        const { data: spinLink, error: verifyError } = await supabase
          .from('spin_links')
          .select('*')
          .eq('token', currentToken)
          .eq('used', false)
          .single();

        if (verifyError || !spinLink) {
          console.error('Token verification failed:', verifyError?.message);
          throw new Error('Invalid or already used token');
        }
        console.log('Token verified successfully');

        // Mark used & record prize
        console.log('Updating spin link:', spinLink.id);
        const { error: updateLinkError, data: updateData } = await supabase
          .from('spin_links')
          .update({ used: true, prize, used_at: new Date().toISOString() })
          .eq('id', spinLink.id)
          .select('id');

        if (updateLinkError || !updateData) {
          console.error('Spin link update failed:', updateLinkError?.message);
          throw new Error('Failed to update spin link: ' + (updateLinkError?.message || 'Unknown error'));
        }
        console.log('Spin link updated successfully');

        // Update client ladoo_count
        console.log('Fetching client ID for referral:', spinLink.referral_id);
        const { data: ref, error: refError } = await supabase
          .from('referrals')
          .select('client_id')
          .eq('id', spinLink.referral_id)
          .single();

        if (refError || !ref) {
          console.error('Failed to fetch client ID:', refError?.message);
          throw new Error('Failed to fetch client_id: ' + (refError?.message || 'Unknown error'));
        }
        console.log('Client ID fetched successfully:', ref.client_id);

        const { data: cli, error: cliError } = await supabase
          .from('clients')
          .select('ladoo_count')
          .eq('id', ref.client_id)
          .single();

        if (cliError || !cli) {
          console.error('Failed to fetch client data:', cliError?.message);
          throw new Error('Failed to fetch client data: ' + (cliError?.message || 'Unknown error'));
        }
        console.log('Current client ladoo count:', cli.ladoo_count);

        const newCount = (cli.ladoo_count || 0) + countWon;
        console.log('Updating client ladoo count to:', newCount);
        const { error: updateError } = await supabase
          .from('clients')
          .update({ ladoo_count: newCount })
          .eq('id', ref.client_id)
          .single();

        if (updateError) {
          console.error('Failed to update client data:', updateError?.message);
          throw new Error('Failed to update client data: ' + (updateError?.message || 'Unknown error'));
        }
        console.log('Client data updated successfully');

        alreadyUsed = true;
        showResult(prize);
        setTimeout(() => window.location.reload(), 1200);
      } catch (error) {
        console.error('Error:', error);
        showError(error.message || 'An error occurred. Please try again.');
      }
    }

    function showResult(prize) {
      resultTitle.textContent = 'Congratulations!';
      resultText.textContent = `You won: ${prize}!`;
      resultModal.style.display = 'flex';
    }
    function showError(msg) {
      resultTitle.textContent = 'Sorry!';
      resultText.textContent = msg;
      resultModal.style.display = 'flex';
    }

    function getRandomColor(){ const c=['#FF6B6B','#4ECDC4','#45B7D1','#96CEB4','#FFEEAD'];return c[Math.floor(Math.random()*c.length)];}
  </script>
</body>
</html>
