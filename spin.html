<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spin to Win!</title>
    <!-- Include Winwheel & GSAP -->
    <script src="https://cdn.jsdelivr.net/npm/winwheel@1.0.1/dist/Winwheel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <!-- Load config as ESM module -->
    <script type="module" src="/js/config.js"></script>
    <link rel="stylesheet" href="/referral-spin-wheel.io/css/styles.css">
    <style>
        /* ... your existing styles ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>Spin to Win Ladoos!</h1>
        <div id="wheel-container">
            <div class="pointer"></div>
            <canvas id="wheel" width="400" height="400"></canvas>
        </div>
        <button id="spin-button" disabled>Spin!</button>
        <div id="result-modal" class="modal">
            <div class="modal-content">
                <h2 id="result-title">Congratulations!</h2>
                <p id="result-text"></p>
                <button id="close-modal">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase, PRIZES } from './js/config.js';

        let wheel;
        let spinButton;
        let resultModal;
        let resultText;
        let resultTitle;
        let closeModalButton;
        let currentToken;
        let alreadyUsed = false;

        document.addEventListener('DOMContentLoaded', async () => {
            spinButton = document.getElementById('spin-button');
            resultModal = document.getElementById('result-modal');
            resultText = document.getElementById('result-text');
            resultTitle = document.getElementById('result-title');
            closeModalButton = document.getElementById('close-modal');

            // Get token from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentToken = urlParams.get('token');

            if (!currentToken) {
                showError('No token provided');
                return;
            }

            // Validate token
            const { data: spinLink, error } = await supabase
                .from('spin_links')
                .select('*')
                .eq('token', currentToken)
                .single();

            if (error || !spinLink) {
                showError('Invalid token');
                return;
            }

            if (spinLink.used) {
                alreadyUsed = true;
                showError('This spin link has already been used.');
                return;
            }

            // Initialize wheel now that token is valid and unused
            initializeWheel();
        });

        function initializeWheel() {
            // Create Winwheel segments from PRIZES
            const segments = PRIZES.map(prize => ({
                fillStyle: getRandomColor(),
                text: prize.text
            }));

            wheel = new Winwheel({
                canvasId: 'wheel',
                numSegments: segments.length,
                segments,
                animation: {
                    type: 'spinToStop',
                    duration: 5,
                    spins: 8,
                    callbackFinished: handleSpinComplete
                }
            });

            spinButton.disabled = false;
            spinButton.addEventListener('click', () => {
                if (alreadyUsed) return;
                // Pick weighted winner index
                const winnerIndex = pickWeightedIndex(PRIZES);
                // Calculate stop angle for that segment
                wheel.animation.stopAngle = wheel.getRandomForSegment(winnerIndex + 1);
                wheel.startAnimation();
                spinButton.disabled = true;
            });
        }

        function pickWeightedIndex(prizes) {
            const total = prizes.reduce((sum, p) => sum + p.weight, 0);
            let r = Math.random() * total;
            for (let i = 0; i < prizes.length; i++) {
                if (r < prizes[i].weight) return i;
                r -= prizes[i].weight;
            }
            return 0;
        }

        async function handleSpinComplete(indicatedSegment) {
            const prize = indicatedSegment.text;
            const countWon = parseInt(prize) || 0;

            try {
                // Mark spin link used and record prize
                const { error: spinError } = await supabase
                    .from('spin_links')
                    .update({ used: true, prize, used_at: new Date().toISOString() })
                    .eq('token', currentToken);
                if (spinError) throw spinError;

                // Fetch referral to get client_id
                const { data: linkRow, error: linkError } = await supabase
                    .from('spin_links')
                    .select('referral_id')
                    .eq('token', currentToken)
                    .single();
                if (linkError) throw linkError;

                const { data: referral, error: refError } = await supabase
                    .from('referrals')
                    .select('client_id')
                    .eq('id', linkRow.referral_id)
                    .single();
                if (refError) throw refError;

                // Update ladoo_count for client
                const { data: clientData, error: clientFetchError } = await supabase
                    .from('clients')
                    .select('ladoo_count')
                    .eq('id', referral.client_id)
                    .single();
                if (clientFetchError) throw clientFetchError;

                const newCount = (clientData.ladoo_count || 0) + countWon;
                const { error: clientUpdateError } = await supabase
                    .from('clients')
                    .update({ ladoo_count: newCount })
                    .eq('id', referral.client_id);
                if (clientUpdateError) throw clientUpdateError;

                alreadyUsed = true;
                showResult(prize);
                // Reload to enforce used flag check
                setTimeout(() => window.location.reload(), 1200);
            } catch (err) {
                console.error('DB error:', err);
                showError('Something went wrong.');
            }
        }

        function showResult(prize) {
            resultTitle.textContent = 'Congratulations!';
            resultText.textContent = `You won: ${prize}!`;
            resultModal.style.display = 'flex';
        }

        function showError(message) {
            resultTitle.textContent = 'Sorry!';
            resultText.textContent = message;
            resultModal.style.display = 'flex';
        }

        closeModalButton.addEventListener('click', () => {
            resultModal.style.display = 'none';
        });

        function getRandomColor() {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
    </script>
</body>
</html>
