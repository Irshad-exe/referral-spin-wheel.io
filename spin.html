<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spin to Win!</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="/referral-spin-wheel.io/css/styles.css">
  <style>
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    existing style#wheel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 40px 0 20px 0;
            position: relative;
        }
        #wheel {
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 4px 24px rgba(0,0,0,0.15);
            border: 8px solid #4CAF50;
            display: block;
        }
        .pointer {
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-bottom: 40px solid #e74c3c;
            position: absolute;
            top: -38px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }
        #spin-button {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 8px;
            background: #4CAF50;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }
        #spin-button:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.4);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #fff;
            padding: 40px 30px;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }
  </style>
</head>
<body>
  <div class="container">
    <h1>Spin to Win Ladoos!</h1>
    <div id="wheel-container">
      <div class="pointer"></div>
      <canvas id="wheel" width="400" height="400"></canvas>
    </div>
    <button id="spin-button" disabled>Spin!</button>
    <div id="result-modal" class="modal">
      <div class="modal-content">
        <h2 id="result-title">Congratulations!</h2>
        <p id="result-text"></p>
        <button id="close-modal">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase config and initialization
    const SUPABASE_URL = 'https://nnqxwcmncytolztvvpvi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ucXh3Y21uY3l0b2x6dHZ2cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY4MDg0MjMsImV4cCI6MjA2MjM4NDQyM30.2Ad2Wv3YC9DwxOG82JBF21BGvkS6gbIFOpPXLCWkdso';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Prize configuration
    const PRIZES = [
      { text: 'Ladoo', color: '#89f26e' },
      { text: 'Better Luck Next Time', color: '#e7706f' }
    ];

    let wheel;
    let spinButton;
    let resultModal;
    let resultText;
    let resultTitle;
    let closeModalButton;
    let currentToken;
    let alreadyUsed = false;

    document.addEventListener('DOMContentLoaded', async () => {
      spinButton = document.getElementById('spin-button');
      resultModal = document.getElementById('result-modal');
      resultText = document.getElementById('result-text');
      resultTitle = document.getElementById('result-title');
      closeModalButton = document.getElementById('close-modal');

      // Initialize GSAP

      // Add event listeners
      if (closeModalButton) {
        closeModalButton.addEventListener('click', () => {
          resultModal.style.display = 'none';
          // Reset the spin button state
          spinButton.disabled = false;
          spinButton.textContent = 'Spin!';
        });
      }

      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      currentToken = urlParams.get('token');
      if (!currentToken) return showError('No token provided');

      // Validate token and check usage status
      const { data: spinLink, error } = await supabase
        .from('spin_links')
        .select('used')
        .eq('token', currentToken)
        .single();
      
      if (error || !spinLink) return showError('Invalid token');
      
      if (spinLink.used) {
        spinButton.disabled = true;
        spinButton.textContent = 'Already Used';
        resultModal.style.display = 'block';
        resultTitle.textContent = 'Already Used';
        resultText.textContent = 'This spin link has already been used.';
        return;
      }

      // Initialize wheel now that token is valid and unused
      initializeWheel();
    });

    // Initialize the custom spinning wheel
    function initializeWheel() {
      const canvas = document.getElementById('wheel');
      const ctx = canvas.getContext('2d');
      let angle = 0;
      let spinning = false;
      let spinTimeout = null;

      // Draw the wheel
      function drawWheel() {
        const numOptions = PRIZES.length;
        const arc = 2 * Math.PI / numOptions;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < numOptions; i++) {
          ctx.beginPath();
          ctx.fillStyle = PRIZES[i].color;
          ctx.moveTo(200, 200);
          ctx.arc(200, 200, 200, angle + i * arc, angle + (i + 1) * arc);
          ctx.lineTo(200, 200);
          ctx.fill();
          ctx.save();
          ctx.translate(200, 200);
          ctx.rotate(angle + (i + 0.5) * arc);
          ctx.textAlign = "right";
          ctx.fillStyle = "#333";
          ctx.font = "bold 20px sans-serif";
          ctx.fillText(PRIZES[i].text, 180, 10);
          ctx.restore();
        }
      }

      // Spin the wheel
      function spinWheel() {
        if (spinning) return;
        spinning = true;
        let spinAngle = Math.random() * 2 * Math.PI + 6 * Math.PI; // 3+ full spins
        let duration = 3500; // ms
        let start = null;
        function animate(ts) {
          if (!start) start = ts;
          let elapsed = ts - start;
          let progress = Math.min(elapsed / duration, 1);
          let ease = 1 - Math.pow(1 - progress, 3); // ease out cubic
          angle = spinAngle * ease;
          drawWheel();
          if (progress < 1) {
            spinTimeout = requestAnimationFrame(animate);
          } else {
            spinning = false;
            handleSpinComplete();
          }
        }
        requestAnimationFrame(animate);
      }

      // Handle spin completion
      function handleSpinComplete() {
        const numOptions = PRIZES.length;
        const arc = 2 * Math.PI / numOptions;
        let selected = Math.floor(((2 * Math.PI - (angle % (2 * Math.PI))) % (2 * Math.PI)) / arc);
        const prize = PRIZES[selected].text;

        // Call your existing Supabase update logic here
        updateDatabaseWithPrize(prize);
      }

      // Initialize the wheel
      drawWheel();
      spinButton.disabled = false;
      spinButton.onclick = () => {
        if (alreadyUsed) return;
        console.log('Spin started');
        spinButton.disabled = true;
        
        // Add spinning animation to the button
        spinButton.style.animation = 'spin 1s linear infinite';
        
        // Start the wheel animation
        spinWheel();
      };

      // Reset the button animation when the wheel stops
      setTimeout(() => {
        spinButton.style.animation = '';
        spinButton.textContent = 'Spin!';
      }, 5000); // Match the animation duration
    }

    const pickWeightedIndex = (prizes) => {
      let total = prizes.reduce((s, p) => s + p.weight, 0);
      let rand = Math.random() * total;
      for (let i = 0; i < prizes.length; i++) {
        if (rand < prizes[i].weight) return i;
        rand -= prizes[i].weight;
      }
      return 0;
    }

    async function handleSpinComplete(indicatedSegment) {
      console.log('Spin completed');
      const prize = indicatedSegment.text;
      const countWon = parseInt(prize) || 0;
      console.log('Prize won:', prize, 'Count:', countWon);
      // TODO: Set clientId from your integration (e.g., from URL token, session, etc.)
      const clientId = window.clientId || null;
      if (!clientId) {
        alert('Client ID not found. Cannot update database.');
        return;
      }
      try {
        await updateDatabaseWithPrize(clientId, prize, countWon);

        // First, verify the token exists and is not used
        console.log('Verifying token:', currentToken);
        const { data: spinLink, error: verifyError } = await supabase
          .from('spin_links')
          .select('*')
          .eq('token', currentToken)
          .eq('used', false)
          .single();

        if (verifyError || !spinLink) {
          console.error('Token verification failed:', verifyError?.message);
          throw new Error('Invalid or already used token');
        }
        console.log('Token verified successfully');

        // Mark used & record prize
        console.log('Updating spin link:', spinLink.id);
        const { error: updateLinkError, data: updateData } = await supabase
          .from('spin_links')
          .update({ used: true, prize, used_at: new Date().toISOString() })
          .eq('id', spinLink.id)
          .select('id');

        if (updateLinkError || !updateData) {
          console.error('Spin link update failed:', updateLinkError?.message);
          throw new Error('Failed to update spin link: ' + (updateLinkError?.message || 'Unknown error'));
        }
        console.log('Spin link updated successfully');

        // Update client ladoo_count
        console.log('Fetching client ID for referral:', spinLink.referral_id);
        const { data: ref, error: refError } = await supabase
          .from('referrals')
          .select('client_id')
          .eq('id', spinLink.referral_id)
          .single();

        if (refError || !ref) {
          console.error('Failed to fetch client ID:', refError?.message);
          throw new Error('Failed to fetch client_id: ' + (refError?.message || 'Unknown error'));
        }
        console.log('Client ID fetched successfully:', ref.client_id);

        const { data: cli, error: cliError } = await supabase
          .from('clients')
          .select('ladoo_count')
          .eq('id', ref.client_id)
          .single();

        if (cliError || !cli) {
          console.error('Failed to fetch client data:', cliError?.message);
          throw new Error('Failed to fetch client data: ' + (cliError?.message || 'Unknown error'));
        }
        console.log('Current client ladoo count:', cli.ladoo_count);

        const newCount = (cli.ladoo_count || 0) + countWon;
        console.log('Updating client ladoo count to:', newCount);
        const { error: updateError } = await supabase
          .from('clients')
          .update({ ladoo_count: newCount })
          .eq('id', ref.client_id)
          .single();

        if (updateError) {
          console.error('Failed to update client data:', updateError?.message);
          throw new Error('Failed to update client data: ' + (updateError?.message || 'Unknown error'));
        }
        console.log('Client data updated successfully');

        alreadyUsed = true;
        showResult(prize);
        setTimeout(() => window.location.reload(), 1200);
      } catch (error) {
        console.error('Error:', error);
        showError(error.message || 'An error occurred. Please try again.');
      }
    }

    function showResult(prize) {
      // Remove spinning animation from button
      spinButton.style.animation = '';
      
      resultTitle.textContent = 'Congratulations!';
      resultText.textContent = `You won: ${prize}!`;
      resultModal.style.display = 'flex';
    }
    function showError(msg) {
      resultTitle.textContent = 'Sorry!';
      resultText.textContent = msg;
      resultModal.style.display = 'flex';
    }

    function getRandomColor(){ const c=['#FF6B6B','#4ECDC4','#45B7D1','#96CEB4','#FFEEAD'];return c[Math.floor(Math.random()*c.length)];}
  </script>
</body>
</html>
