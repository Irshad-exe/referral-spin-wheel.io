<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1d4ed8">
    <title>Client Dashboard - LakshInvestment</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/auth-loader.js"></script>
    <script type="module" src="js/admin-auth.js"></script>
    <style>
        .main-content {
            padding: 2rem 0;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .stat-box {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .stat-box h3 {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-box p {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }
        
        .table-container {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-top: 2rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        
        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-eligible {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .spin-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .spin-button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .spin-button:disabled {
            background-color: var(--bg-secondary);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }
        
        .view-referrals {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .view-referrals:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
        }
    </style>
</head>
<body>
    <!-- Include Navigation -->
    <div id="navbar"></div>

    <main class="main-content">
        <div class="container">
            <h1>Client Ladoo Dashboard</h1>
            
            <div class="stats-container">
                <div class="stat-box">
                    <h3>Total Clients</h3>
                    <p id="total-clients">0</p>
                </div>
                <div class="stat-box">
                    <h3>Clients with 3+ Ladoos</h3>
                    <p id="eligible-clients">0</p>
                </div>
            </div>

            <div class="table-container">
                <table id="clients-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Ladoo Count</th>
                            <th>Status</th>
                            <th>Actions</th>
                            <th>Spin Wheel</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Client rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        import { supabase } from './js/admin-auth.js';
        import { ROUTES, navigateTo } from './js/routes.js';
        
        // Initialize Supabase client
        const SUPABASE_URL = 'https://nnqxwcmncytolztvvpvi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ucXh3Y21uY3l0b2x6dHZ2cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY4MDg0MjMsImV4cCI6MjA2MjM4NDQyM30.2Ad2Wv3YC9DwxOG82JBF21BGvkS6gbIFOpPXLCWkdso';
        
        // Wait for Supabase to be loaded
        async function waitForSupabase() {
            return new Promise((resolve) => {
                if (window.supabase) {
                    resolve();
                } else {
                    const checkSupabase = setInterval(() => {
                        if (window.supabase) {
                            clearInterval(checkSupabase);
                            resolve();
                        }
                    }, 100);
                }
            });
        }

        // Initialize Supabase client
        async function initializeSupabase() {
            await waitForSupabase();
            console.log('Supabase loaded, initializing client...');
            const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: true
                }
            });
            console.log('Supabase client initialized');
            return supabaseClient;
        }

        // Initialize Supabase and load data
        let supabaseClient;
        async function initialize() {
            try {
                supabaseClient = await initializeSupabase();
                await loadClients();
            } catch (error) {
                console.error('Initialization error:', error);
                navigateTo(ROUTES.LOGIN);
            }
        }

        // Load clients data
        async function loadClients() {
            try {
                const { data: clients, error } = await supabaseClient
                    .from('clients')
                    .select('*')
                    .order('ladoo_count', { ascending: false });

                if (error) {
                    console.error('Error loading clients:', error);
                    return;
                }

                updateStats(clients);
                updateTable(clients);
            } catch (error) {
                console.error('Error in loadClients:', error);
            }
        }

        function updateStats(clients) {
            document.getElementById('total-clients').textContent = clients.length;
            const eligibleCount = clients.filter(c => c.ladoo_count >= 3).length;
            document.getElementById('eligible-clients').textContent = eligibleCount;
        }

        function updateTable(clients) {
            const tbody = document.querySelector('#clients-table tbody');
            tbody.innerHTML = '';

            clients.forEach(client => {
                const row = document.createElement('tr');
                if (client.ladoo_count >= 3) {
                    row.classList.add('eligible');
                }

                row.innerHTML = `
                    <td>${client.name}</td>
                    <td>${client.contact_info}</td>
                    <td>${client.ladoo_count}</td>
                    <td>${getStatusText(client.ladoo_count)}</td>
                    <td>
                        ${client.ladoo_count >= 3 ? '<button onclick="spinWheel(${client.id})" class="spin-button">Spin Wheel</button>' : ''}
                    </td>
                    <td>
                        <button onclick="viewReferrals('${client.id}')" class="btn-small">
                            View Referrals
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        function getStatusText(ladooCount) {
            if (ladooCount >= 3) {
                return '<span class="status-eligible">Eligible for Reward</span>';
            } else {
                return '<span class="status-pending">Pending</span>';
            }
        }

        async function viewReferrals(clientId) {
            const { data: referrals, error } = await supabaseClient
                .from('referrals')
                .select(`
                    *,
                    spin_links (
                        prize,
                        used,
                        used_at
                    )
                `)
                .eq('client_id', clientId)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading referrals:', error);
                return;
            }

            // Create and show modal with referrals
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Referral History</h2>
                    <div class="referrals-list">
                        ${referrals.map(ref => `
                            <div class="referral-item">
                                <p><strong>Referred:</strong> ${ref.referee_name}</p>
                                <p><strong>Contact:</strong> ${ref.referee_contact}</p>
                                <p><strong>Status:</strong> ${ref.status}</p>
                                ${ref.spin_links[0] ? `
                                    <p><strong>Spin Result:</strong> ${ref.spin_links[0].prize || 'Not used'}</p>
                                    <p><strong>Used At:</strong> ${ref.spin_links[0].used_at || 'Not used'}</p>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="this.closest('.modal').remove()">Close</button>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function spinWheel(clientId) {
            const { data: client, error } = await supabaseClient
                .from('clients')
                .select('*')
                .eq('id', clientId)
                .single();

            if (error) {
                console.error('Error loading client:', error);
                return;
            }

            if (client.ladoo_count < 3) {
                alert('Client needs at least 3 Ladoos to spin the wheel!');
                return;
            }

            // Pick a random prize
            const prizeIndex = pickWeightedIndex(PRIZES);
            const prize = PRIZES[prizeIndex].text;
            const countWon = parseInt(prize) || 0;

            // Create a new spin link record
            const { error: insertError } = await supabaseClient
                .from('spin_links')
                .insert([
                    {
                        client_id: clientId,
                        prize: prize,
                        used: true,
                        used_at: new Date().toISOString()
                    }
                ]);

            if (insertError) {
                console.error('Error creating spin link:', insertError);
                return;
            }

            // Update client's ladoo count
            const { error: updateError } = await supabaseClient
                .from('clients')
                .update({ ladoo_count: client.ladoo_count + countWon })
                .eq('id', clientId);

            if (updateError) {
                console.error('Error updating client:', updateError);
                return;
            }

            // Refresh the table
            await loadClients();
            alert(`Congratulations! You won ${countWon} Ladoos!`);
        }

        // Load navigation
        fetch('components/navbar.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('navbar').innerHTML = html;
                
                // Initialize mobile menu
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                const navLinks = document.getElementById('navLinks');
                const dropdownToggles = document.querySelectorAll('.nav-dropdown-toggle');
                
                if (mobileMenuBtn && navLinks) {
                    mobileMenuBtn.addEventListener('click', function() {
                        this.classList.toggle('active');
                        navLinks.classList.toggle('active');
                        document.body.classList.toggle('menu-open');
                    });
                }
                
                // Dropdown toggle for mobile
                dropdownToggles.forEach(toggle => {
                    toggle.addEventListener('click', function(e) {
                        if (window.innerWidth <= 768) {
                            e.preventDefault();
                            e.stopPropagation();
                            const dropdown = this.closest('.nav-dropdown');
                            dropdown.classList.toggle('active');
                        }
                    });
                });
                
                // Close dropdowns when clicking outside
                document.addEventListener('click', function(e) {
                    if (window.innerWidth > 768) return;
                    
                    const isClickInsideNav = navLinks && navLinks.contains(e.target);
                    const isClickOnMenuBtn = mobileMenuBtn && mobileMenuBtn.contains(e.target);
                    
                    if (!isClickInsideNav && !isClickOnMenuBtn) {
                        if (mobileMenuBtn) mobileMenuBtn.classList.remove('active');
                        if (navLinks) navLinks.classList.remove('active');
                        document.body.classList.remove('menu-open');
                    }
                });
            })
            .catch(error => {
                console.error('Error loading navigation:', error);
            });
        
        // Close dropdown when resizing to desktop
        window.addEventListener('resize', function() {
            const dropdowns = document.querySelectorAll('.nav-dropdown');
            if (window.innerWidth > 768) {
                dropdowns.forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
            }
        });

        // Initialize when the page loads
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html> 