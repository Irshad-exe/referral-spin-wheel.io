<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1d4ed8">
    <title>Client Dashboard - LakshInvestment</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://irshad-exe.github.io/referral-spin-wheel.io/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://irshad-exe.github.io/referral-spin-wheel.io/js/auth-loader.js"></script>
    <script type="module" src="https://irshad-exe.github.io/referral-spin-wheel.io/js/admin-auth.js"></script>
    <style>
        .main-content {
            padding: 2rem 0;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .stat-box {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .stat-box h3 {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-box p {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }
        
        .table-container {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-top: 2rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        
        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-eligible {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .spin-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .spin-button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .spin-button:disabled {
            background-color: var(--bg-secondary);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }
        
        .view-referrals {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .view-referrals:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
        }
    </style>
</head>
<body>
    <!-- Include Navigation -->
    <div id="navbar"></div>

    <main class="main-content">
        <div class="container">
            <h1>Client Ladoo Dashboard</h1>
            
            <div class="stats-container">
                <div class="stat-box">
                    <h3>Total Clients</h3>
                    <p id="total-clients">0</p>
                </div>
                <div class="stat-box">
                    <h3>Clients with 3+ Ladoos</h3>
                    <p id="eligible-clients">0</p>
                </div>
            </div>

            <div class="table-container">
                <table id="clients-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Ladoo Count</th>
                            <th>Status</th>
                            <th>Actions</th>
                            <th>Spin Wheel</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Client rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        import { supabase, initializeMiddleware, ROUTES, navigateTo } from 'https://irshad-exe.github.io/referral-spin-wheel.io/js/admin-auth.js';
        
        // Initialize Supabase and middleware
        async function initialize() {
            try {
                // Check authentication first
                const isAuthenticated = await initializeMiddleware();
                if (!isAuthenticated) {
                    return;
                }
                
                // Load clients if authenticated
                await loadClients();
            } catch (error) {
                console.error('Initialization error:', error);
                navigateTo(ROUTES.LOGIN);
            }
        }
        
        // Load clients from Supabase
        async function loadClients() {
            try {
                const { data: clients, error } = await supabase
                    .from('clients')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                updateClientStats(clients);
                renderClientTable(clients);
            } catch (error) {
                console.error('Error loading clients:', error);
                showAlert('Error loading clients. Please try again.', 'error');
            }
        }
        
        // Update client statistics
        function updateClientStats(clients) {
            const totalClients = clients.length;
            const activeClients = clients.filter(client => client.status === 'active').length;
            const pendingClients = clients.filter(client => client.status === 'pending').length;
            
            document.getElementById('total-clients').textContent = totalClients;
            document.getElementById('active-clients').textContent = activeClients;
            document.getElementById('pending-clients').textContent = pendingClients;
        }
        
        // Render client table
        function renderClientTable(clients) {
            const tbody = document.getElementById('clients-tbody');
            tbody.innerHTML = '';
            
            clients.forEach(client => {
                const row = document.createElement('tr');
                
                // Format created_at date
                const createdAt = client.created_at ? new Date(client.created_at).toLocaleDateString() : 'N/A';
                
                // Determine status badge
                let statusClass = 'status-inactive';
                let statusText = 'Inactive';
                
                if (client.status === 'active') {
                    statusClass = 'status-active';
                    statusText = 'Active';
                } else if (client.status === 'pending') {
                    statusClass = 'status-pending';
                    statusText = 'Pending';
                }
                
                row.innerHTML = `
                    <td data-label="Name">${escapeHtml(client.name || 'N/A')}</td>
                    <td data-label="Email">${escapeHtml(client.email || 'N/A')}</td>
                    <td data-label="UCC">${escapeHtml(client.ucc || 'N/A')}</td>
                    <td data-label="Contact">${escapeHtml(client.contact_info || 'N/A')}</td>
                    <td data-label="Status"><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td data-label="Actions">
                        <button class="button btn-outline-primary btn-sm" onclick="viewReferrals(${client.id})">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="button btn-outline-success btn-sm" onclick="spinWheel(${client.id})">
                            <i class="fas fa-gift"></i> Spin
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // View client referrals
        async function viewReferrals(clientId) {
            try {
                const { data: referrals, error } = await supabase
                    .from('referrals')
                    .select('*')
                    .eq('client_id', clientId)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // TODO: Implement referral view modal
                console.log('Referrals:', referrals);
            } catch (error) {
                console.error('Error loading referrals:', error);
                showAlert('Error loading referrals. Please try again.', 'error');
            }
        }
        
        // Spin wheel for client
        async function spinWheel(clientId) {
            try {
                const { data: spinLink, error } = await supabase
                    .from('spin_links')
                    .insert({
                        client_id: clientId,
                        token: crypto.randomUUID()
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                const spinUrl = `${ROUTES.SPIN}?token=${spinLink.token}`;
                window.open(spinUrl, '_blank');
            } catch (error) {
                console.error('Error creating spin link:', error);
                showAlert('Error creating spin link. Please try again.', 'error');
            }
        }
        
        // Helper function to escape HTML
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        // Show alert message
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Initialize when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initialize();
        });
    </script>
</body>
</html> 